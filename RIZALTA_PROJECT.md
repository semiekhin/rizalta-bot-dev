# RIZALTA BOT — Паспорт проекта

## Общая информация

| Параметр | Значение |
|----------|----------|
| Название | RIZALTA Telegram Bot |
| Назначение | AI-консультант для риэлторов по инвестициям в курортную недвижимость |
| Объект | RIZALTA Resort Belokurikha, Алтай |
| Telegram | @RealtMeAI_bot |
| Сервер | 72.56.64.91 (Timeweb Cloud NL-50) |
| GitHub | https://github.com/semiekhin/rizalta-bot |

## Конфигурация сервера

| Параметр | Значение |
|----------|----------|
| CPU | 2 x 3.3 ГГц |
| RAM | 4 GB |
| Диск | 50 GB NVMe |
| Сеть | 1 Гбит/с |
| ОС | Ubuntu 24.04 |
| Цена | ~1500 ₽/мес |

## Технологический стек

| Компонент | Технология |
|-----------|------------|
| Язык | Python 3.12 |
| Фреймворк | FastAPI + Uvicorn |
| AI | OpenAI GPT-4o-mini |
| Голос | OpenAI Whisper API |
| БД | SQLite |
| PDF | ReportLab |
| Прокси | Cloudflare Tunnel |
| Процессы | Systemd |

## Структура проекта

```
/opt/bot/
├── app.py                    # Главный файл, webhook, роутинг
├── .env                      # Секреты (токены, ключи API)
├── properties.db             # База данных SQLite
├── requirements.txt          # Зависимости Python
│
├── config/
│   └── settings.py           # Конфигурация, переменные окружения
│
├── handlers/
│   ├── __init__.py           # Экспорт всех обработчиков
│   ├── menu.py               # Главное меню, навигация
│   ├── ai_chat.py            # AI консультант + Function Calling
│   ├── booking.py            # Старая запись на показ
│   ├── booking_calendar.py   # Новый календарь бронирования
│   ├── calc_dynamic.py       # Динамические расчёты ROI/рассрочки
│   ├── docs.py               # Отправка документов (ДДУ, аренда)
│   ├── kp.py                 # Коммерческие предложения
│   ├── media.py              # Медиа-материалы, презентация
│   └── units.py              # Работа с лотами
│
├── services/
│   ├── telegram.py           # Отправка сообщений, файлов, download_file
│   ├── ai_chat.py            # OpenAI API + Function Calling
│   ├── speech.py             # Whisper API (голосовые сообщения)
│   ├── calculations.py       # Финансовые расчёты
│   ├── kp_generator.py       # Генерация КП в PDF
│   └── kp_search.py          # Поиск КП по параметрам
│
├── models/
│   └── state.py              # Состояния диалогов
│
├── data/
│   ├── units.json            # 69 лотов с ценами
│   ├── rizalta_finance.json  # Финансовые сценарии
│   ├── rizalta_knowledge_base.txt  # База знаний для AI
│   ├── layouts/              # Планировки квартир
│   └── *.md, *.json          # Тексты, программы
│
├── kp_all/                   # 69 КП в формате JPG
├── media/                    # Презентация, видео, фото
│
├── backup.sh                 # Ежедневный бэкап
├── backup_weekly.sh          # Еженедельный бэкап медиа
└── update_webhook.sh         # Автообновление webhook
```

## Ключевые функции бота

### 1. AI-консультант
- Отвечает на вопросы о проекте из базы знаний
- Function Calling для контекстных запросов
- Понимает: "скинь презу", "закрепи клиента", "что свободно?"

### 2. Коммерческие предложения (69 шт.)
- Поиск по площади (22-30, 31-40, 41-50, 51-70, 71-90, 90+ м²)
- Поиск по бюджету (до 15, 15-18, 18-22, 22-26, 26-30, 30+ млн)
- Кнопка "Показать все" для полного списка

### 3. Расчёты
- ROI по каждому лоту (доходность, окупаемость)
- Рассрочка (ипотека, траншевая, классическая)
- Динамические расчёты для всех 69 лотов

### 4. Календарь бронирования
- Выбор специалиста (3 специалиста)
- Выбор даты (Пн-Сб, 14 дней вперёд)
- Выбор времени (10:00-16:00, слоты по 1 часу)
- Подтверждение специалистом через Telegram
- Email уведомления

### 5. Голосовое управление
- Whisper API для распознавания речи
- Поддержка русского языка
- Автоматическая обработка как текст

### 6. Документы и медиа
- Презентация проекта (PDF)
- Договоры (ДДУ, аренда)
- Фото, видео, планировки

## Безопасность

| Компонент | Статус |
|-----------|--------|
| Swap 1GB | ✅ Настроен |
| fail2ban | ✅ Работает |
| UFW Firewall | ✅ Активен |
| Cloudflare Tunnel | ✅ Скрывает IP |
| Автобэкап ежедневный (3:00) | ✅ .env, БД, data → email |
| Автобэкап еженедельный (Вс 4:00) | ✅ КП, медиа → email |
| Systemd автозапуск | ✅ 4 сервиса |
| Автообновление webhook | ✅ При перезапуске |

## Systemd сервисы

```bash
# RIZALTA Bot
systemctl status rizalta-bot
systemctl status cloudflare-rizalta

# OAZIS Bot (второй проект на сервере)
systemctl status oazis-bot
systemctl status cloudflare-oazis
```

## Полезные команды

```bash
# Логи бота
journalctl -u rizalta-bot -f

# Перезапуск
systemctl restart rizalta-bot

# Проверка webhook
curl "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getWebhookInfo"

# Ручной бэкап
/opt/bot/backup.sh

# Проверка ресурсов
free -m && df -h
```

## Контакты

- Email для бэкапов: 89181011091s@mail.ru
- Email бота: rizalta-bot@mail.ru

---

## История изменений

### v1.6.0 (08.12.2025)
- Модуль новостей и инвест-дайджест
- Курсы валют ЦБ РФ (USD, EUR, CNY)
- Погода в Белокурихе + 3-часовой прогноз (Open-Meteo API)
- Авиабилеты Москва→Горно-Алтайск (Aviasales API)
- 15 новостей от РИА, Коммерсант, Lenta, Ведомости, ТАСС
- Красивое форматирование с эмодзи и ссылками на источники
- Кнопка "Новости" в главном меню


### v1.5.0 (07.12.2025)
- AI Function Calling: 5 новых функций (презентация, фиксация, шахматка, документы, медиа)
- Календарь бронирования с подтверждением специалистом
- Голосовое управление (Whisper API)
- Кнопка "Показать все" в КП
- Безопасность: Swap, fail2ban, автобэкапы, systemd
- Апгрейд сервера: 2 CPU, 4GB RAM, 50GB диск

### v1.3.2 (06.12.2025)
- Площадь как ключ для лотов
- Договоры ДДУ и аренды
- Информация о гостиничном сервисе

### v1.3 (04.12.2025)
- Динамические расчёты ROI для всех 69 лотов
- Расчёт рассрочки (ипотека, траншевая, классическая)
- Переработанная структура handlers/

### v1.0 (01.12.2025)
- Базовый функционал бота
- AI консультант с базой знаний
- 69 коммерческих предложений
- Главное меню и навигация

---

## Dev-окружение (v1.7.0-dev)

### Два репозитория
| Репо | Назначение | Бот |
|------|-----------|-----|
| github.com/semiekhin/rizalta-bot | Prod | @RealtMeAI_bot |
| github.com/semiekhin/rizalta-bot-dev | Dev | @rizaltatestdevop_bot |

### Структура dev
```
/opt/bot-dev/
├── services/
│   ├── parser_rclick.py      # Парсер ri.rclick.ru
│   ├── units_db.py           # Сервис работы с БД
│   └── kp_pdf_generator.py   # PDF генератор КП
├── handlers/
│   └── kp.py                 # Переписан под units_db
├── kp_all/                   # 69 КП (jpg + html)
├── docs/                     # Документы, презентации
├── properties.db             # 369 актуальных квартир
└── run_polling.py            # Polling mode
```

### История изменений

#### v1.7.0-dev (09.12.2025)
- Dev-окружение с отдельным репо
- Парсер ri.rclick.ru: 369 квартир
- Единый источник данных: ri.rclick.ru → properties.db
- Сервис units_db.py
- PDF генератор КП (базовая версия)
- handlers/kp.py переписан под новую архитектуру
