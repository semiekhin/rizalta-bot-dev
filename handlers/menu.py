"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–µ–Ω—é –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
"""

import os
from typing import Dict, Any

from config.settings import (
    MAIN_MENU_BUTTONS,
    ABOUT_PROJECT_BUTTONS,
    CALCULATIONS_BUTTONS,
    UNIT_SELECT_BUTTONS,
    TEXT_WHY_RIZALTA_PATH,
    ARCHITECT_PDF_PATH,
)
from models.state import (
    clear_user_state,
    clear_dialog_state,
    set_dialog_state,
    DialogStates,
)
from services.telegram import send_message, send_message_inline, send_document
from services.data_loader import load_why_rizalta_text


async def handle_start(chat_id: int, text: str = "", user_info: Dict[str, Any] = None):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    clear_user_state(chat_id)
    
    welcome = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RIZALTA AI SYSTEM!\n\n"
        "–Ø –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–µ–∫—Ç–∞ RIZALTA Resort Belokurikha ‚Äî "
        "–ø–µ—Ä–≤—ã–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º –≤ –∫—É—Ä–æ—Ä—Ç–Ω—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ê–ª—Ç–∞—è.\n\n"
        "ü§ñ <b>–ß—Ç–æ —è —É–º–µ—é:</b>\n"
        "‚Ä¢ –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≥–æ–ª–æ—Å–æ–º –∏ —Ç–µ–∫—Å—Ç–æ–º\n"
        "‚Ä¢ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –¥–ª—è –ª—é–±–æ–≥–æ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞\n"
        "‚Ä¢ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ö–ü –≤ PDF\n"
        "‚Ä¢ –ü–æ–¥–±–∏—Ä–∞—é –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∏ –∏–ø–æ—Ç–µ–∫–∏\n"
        "‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—é –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏\n"
        "‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—é –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã, –Ω–æ–≤–æ—Å—Ç–∏, —Ü–µ–Ω—ã –Ω–∞ –±–∏–ª–µ—Ç—ã\n"
        "‚Ä¢ –ü–æ–º–æ–≥–∞—é –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑\n\n"
        "üí° –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ –Ω–∞–¥–∏–∫—Ç—É–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–π–º—É!\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ –∏–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ üëá"
    )
    
    await send_message(chat_id, welcome, with_keyboard=True, buttons=MAIN_MENU_BUTTONS)


async def handle_help(chat_id: int):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ /help."""
    text = (
        "üÜò <b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É RIZALTA</b>\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å.\n\n"
        "<b>–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:</b>\n"
        "üìñ –û –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ RIZALTA –∏ –ê–ª—Ç–∞–µ\n"
        "üí∞ –†–∞—Å—á—ë—Ç—ã ‚Äî –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, —Ä–∞—Å—Å—Ä–æ—á–∫–∞, –∏–ø–æ—Ç–µ–∫–∞\n"
        "üéØ –ü–æ–¥–æ–±—Ä–∞—Ç—å –ª–æ—Ç ‚Äî –ø–æ–¥–±–æ—Ä –ø–æ –±—é–¥–∂–µ—Ç—É\n"
        "üìé –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã\n"
        "üî• –ó–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî —Å–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º\n\n"
        "–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º."
    )
    await send_message(chat_id, text, with_keyboard=True, buttons=MAIN_MENU_BUTTONS)


async def handle_back(chat_id: int):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    clear_dialog_state(chat_id)
    
    await send_message(
        chat_id,
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        with_keyboard=True,
        buttons=MAIN_MENU_BUTTONS,
    )


async def handle_main_menu(chat_id: int):
    """–ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    await send_message(
        chat_id,
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        with_keyboard=True,
        buttons=MAIN_MENU_BUTTONS,
    )


# ====== –ú–µ–Ω—é "–û –ø—Ä–æ–µ–∫—Ç–µ" ======

async def handle_about_project(chat_id: int):
    """–ü–æ–¥–º–µ–Ω—é '–û –ø—Ä–æ–µ–∫—Ç–µ'."""
    await send_message(
        chat_id,
        "üìñ <b>–û –ø—Ä–æ–µ–∫—Ç–µ RIZALTA</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å:",
        with_keyboard=True,
        buttons=ABOUT_PROJECT_BUTTONS,
    )


async def handle_why_altai(chat_id: int):
    """
    ‚ùáÔ∏è –ü–æ—á–µ–º—É –ê–ª—Ç–∞–π ‚Äî –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–¥–∞—é—â–∏–π —Ç–µ–∫—Å—Ç.
    """
    text = (
        "<b>–ü–æ—á–µ–º—É –Ω—É–∂–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ RIZALTA</b>\n\n"
        "‚ùáÔ∏è <b>–ê–ª—Ç–∞–π</b>\n\n"
        "üèÜ –ë–æ–ª–µ–µ 5 –º–ª–Ω —á–µ–ª–æ–≤–µ–∫ –≤ –≥–æ–¥. –†–µ–≥–∏–æ–Ω –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏.\n"
        "üìà –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ–¥—É—â–∏—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤: —Ä–æ—Å—Ç —Ç—É—Ä–ø–æ—Ç–æ–∫–∞ –æ–∫–æ–ª–æ +40% –≤ –±–ª–∏–∂–∞–π—à–∏–µ 5 –ª–µ—Ç.\n"
        "üèîÔ∏è –°–æ—á–µ—Ç–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–∑–¥–∞–Ω–Ω–æ–π –ø—Ä–∏—Ä–æ–¥—ã –∏ —Ä–∞–∑–≤–∏—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.\n"
        "üëº –†–µ–≥–∏–æ–Ω —É–¥–∞–ª—ë–Ω –æ—Ç –∑–æ–Ω –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.\n"
        "üöÄ –°—Ç–∞–±–∏–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π —Ä–æ—Å—Ç —Ü–µ–Ω –Ω–∞ –∑–µ–º–ª—é –∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å ‚Äî –æ–∫–æ–ª–æ 30% –≤ –≥–æ–¥.\n"
        "üí∞ –ì–ª–∞–≤–Ω—ã–π –∏–Ω–≤–µ—Å—Ç–æ—Ä ‚Äî –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ: –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –≤–ª–æ–∂–∏—Ç—å –±–æ–ª–µ–µ 300 –º–ª—Ä–¥ ‚ÇΩ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 5 –ª–µ—Ç.\n\n"
        "‚ùáÔ∏è <b>–ë–µ–ª–æ–∫—É—Ä–∏—Ö–∞</b>\n\n"
        "üó∫Ô∏è ¬´–í–æ—Ä–æ—Ç–∞ –ê–ª—Ç–∞—è¬ª, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–∞–º–æ–º —Å–µ—Ä–¥—Ü–µ —Ä–µ–≥–∏–æ–Ω–∞.\n"
        "ü•á –û–¥–∏–Ω –∏–∑ –ª—É—á—à–∏—Ö –∫—É—Ä–æ—Ä—Ç–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏.\n"
        "üè• –ö—Ä—É–≥–ª–æ–≥–æ–¥–∏—á–Ω—ã–π –ª–µ—á–µ–±–Ω—ã–π –∫—É—Ä–æ—Ä—Ç —Å —Ä–∞–∑–≤–∏—Ç–æ–π —Å–∞–Ω–∞—Ç–æ—Ä–Ω–æ-–∫—É—Ä–æ—Ä—Ç–Ω–æ–π –±–∞–∑–æ–π.\n\n"
        "‚ùáÔ∏è <b>RIZALTA</b>\n\n"
        "üè® –ö–æ–º–ø–ª–µ–∫—Å –æ—Ç–µ–ª–µ–π —Å –±–æ–≥–∞—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π ‚Äî –ø–æ–¥–æ–π–¥—ë—Ç –∏ –¥–ª—è –æ—Ç–¥—ã—Ö–∞, –∏ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.\n"
        "üëçüèæ –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ—Ç–µ–ª—å–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å –æ–ø—ã—Ç–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–º –±–∏–∑–Ω–µ—Å–æ–º.\n"
        "ü´∞ –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º CORE.XP, ‚Äî –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ –≤—ã—à–µ, —á–µ–º —É –æ–±—ã—á–Ω–æ–≥–æ –∂–∏–ª—å—è –∏–ª–∏ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.\n"
        "üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–π: –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ø–æ –§–ó-214 —Å –ø—Ä–æ–µ–∫—Ç–Ω—ã–º —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ–º –°–±–µ—Ä–±–∞–Ω–∫–∞.\n\n"
        "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –ª–æ—Ç –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç –∏ –ø–æ–∫–∞–∑–∞—Ç—å, "
        "–∫–∞–∫ —ç—Ç–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å. üí¨"
    )
    
    inline_buttons = [
        [
            {"text": "üéØ –ü–æ–¥–æ–±—Ä–∞—Ç—å –ª–æ—Ç", "callback_data": "select_lot"},
            {"text": "üìû –í—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", "callback_data": "call_manager"}
        ]
    ]
    
    await send_message_inline(chat_id, text, inline_buttons)


async def handle_why_rizalta(chat_id: int):
    """
    ‚ú® –ü–æ—á–µ–º—É RIZALTA ‚Äî —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞.
    """
    text = load_why_rizalta_text()
    
    inline_buttons = [
        [
            {"text": "üìä –†–∞—Å—á—ë—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏", "callback_data": "calculate_roi"},
            {"text": "üìû –í—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", "callback_data": "call_manager"}
        ]
    ]
    
    await send_message_inline(chat_id, text, inline_buttons)


async def handle_architect(chat_id: int):
    """
    üë®‚Äçüé® –û–± –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ PDF.
    """
    if os.path.exists(ARCHITECT_PDF_PATH):
        await send_message(
            chat_id,
            "üë®‚Äçüé® –û—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–± –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ RIZALTA.",
        )
        await send_document(chat_id, ARCHITECT_PDF_PATH)
    else:
        await send_message(
            chat_id,
            "–§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–µ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä."
        )


# ====== –ú–µ–Ω—é "–†–∞—Å—á—ë—Ç—ã" ======

async def handle_calculations_menu(chat_id: int):
    """–ü–æ–¥–º–µ–Ω—é '–†–∞—Å—á—ë—Ç—ã'."""
    await send_message(
        chat_id,
        "üí∞ <b>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á—ë—Ç—ã</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:",
        with_keyboard=True,
        buttons=CALCULATIONS_BUTTONS,
    )


async def handle_choose_unit_for_roi(chat_id: int):
    """–í—ã–±–æ—Ä —é–Ω–∏—Ç–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏."""
    set_dialog_state(chat_id, DialogStates.CHOOSE_ROI_UNIT)
    
    await send_message(
        chat_id,
        "üìä <b>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞:",
        with_keyboard=True,
        buttons=UNIT_SELECT_BUTTONS,
    )


async def handle_choose_unit_for_finance(chat_id: int):
    """–í—ã–±–æ—Ä —é–Ω–∏—Ç–∞ –¥–ª—è —Ä–∞—Å—Å—Ä–æ—á–∫–∏/–∏–ø–æ—Ç–µ–∫–∏."""
    set_dialog_state(chat_id, DialogStates.CHOOSE_FINANCE_UNIT)
    
    await send_message(
        chat_id,
        "üí≥ <b>–†–∞—Å—Å—Ä–æ—á–∫–∞ –∏ –∏–ø–æ—Ç–µ–∫–∞</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞:",
        with_keyboard=True,
        buttons=UNIT_SELECT_BUTTONS,
    )


async def handle_choose_unit_for_layout(chat_id: int):
    """–í—ã–±–æ—Ä —é–Ω–∏—Ç–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏."""
    set_dialog_state(chat_id, DialogStates.CHOOSE_PLAN_UNIT)
    
    await send_message(
        chat_id,
        "üìé –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É:",
        with_keyboard=True,
        buttons=UNIT_SELECT_BUTTONS,
    )


async def handle_myid(chat_id: int, user_info: dict = None):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –µ–≥–æ Telegram chat_id."""
    username = user_info.get("username", "") if user_info else ""
    first_name = user_info.get("first_name", "") if user_info else ""
    
    text = f"‚ÑπÔ∏è <b>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ Telegram:</b>\n\nüÜî Chat ID: <code>{chat_id}</code>\n"
    if username:
        text += f"üë§ Username: @{username}\n"
    if first_name:
        text += f"üìù –ò–º—è: {first_name}\n"
    text += "\nüí° <i>Chat ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.</i>"
    
    await send_message(chat_id, text)
